## 层叠上下文和 z-index

当把一个元素从文档流中移除时，我们就需要管理之前文档流处理的所有事情了。

首先要确保元素不会不小心跑到浏览器视口之外，导致用户会看不到元素。其次要保证元素不会小心挡住重要内容。最后还有层叠的问题。

在同一页面定位多个元素时，可能会遇到两个不同定位的元素重叠的现象。有时会发现“错误”的元素出现在其他元素之前。

### 理解渲染过程和层叠顺序

浏览器将 HTML 解析为 DOM 的同时还创建了另一个树形结构，叫做**渲染树**（render tree）。它代表了每个元素的视觉样式和位置。同时还决定浏览器**绘制**元素的顺序。顺序很重要，因为如果元素刚好重叠，后绘制的元素就会出现在先绘制的元素前面。

浏览器会先绘制所有非定位的元素，然后绘制定位元素。默认情况下，所有的定位元素会出现在非定位元素前面。

注意，在定位元素里，第二个定位元素还是出现在第一个定位元素前面。定位元素会被放到前面，但是基于源码的层叠关系并没有改变。

对相对定位或绝对定位的元素来说，通常无法用改变标记位置的方法解决层叠问题。相对定位依赖于文档流，绝对定位元素依赖于它的定位祖先节点。

### 用 z-index 控制层叠顺序

z-index 属性的值可以是任意整数（正负都行）。z 表示的是笛卡尔 x-y-z 坐标系里的深度方向。拥有较高 z-index 的元素出现在拥有较低 z-index 的元素前面。拥有负数 z-index 的元素出现在静态元素后面。

使用 z-index 时要注意两个小陷阱：

1. z-index 只在定位元素上生效，不能用它控制静态元素。
2. 给一个定位元素加上 z-index 可以创建层叠上下文。

### 理解层叠上下文

一个**层叠上下文**包含一个元素或者由浏览器一起绘制的一组元素。其中一个元素会作为层叠上下文的根，比如给一个定位元素加上 z-index 的时候，它就变成了一个新的层叠上下文的根。所有后代元素就是这个层叠上下文的一部分。

层叠上下文负责决定哪些元素出现在另一些元素前面，而 BFC 负责处理文档流，以及元素是否会重叠。

实际上将层叠上下文里的所有元素一起绘制会造成严重的后果：层叠上下文之外的元素无法放在层叠上下文内的两个元素之间。换句话说，如果一个元素叠放在一个层叠上下文前面，那么层叠上下文里没有元素可以被拉到该元素前面。同理，如果一个元素被放在层叠上下文后面，层叠上下文里没有元素能出现在该元素后面。

所有层叠上下文内的元素会按以下顺序，从后到后叠放：

- 层叠上下文的根
- z-index 为负的定位元素（及其子元素）
- 非定位元素
- z-index 为 auto 的定位元素（及其子元素）
- z-index 为正的定位元素（及其子元素）

如果发现 z-index 没有按照预期表现，就在 DOM 树里往上找到元素的祖先节点，直到发现层叠上下文的根。然后给它设置 z-index，将整个层叠上下文向前或者向后放。
